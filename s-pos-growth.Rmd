---
title: "B.1.617.2 Growth rate analysis and transmission advantage"
author: "Rob Challen"
date: '`r format(Sys.Date(), "%d-%m-%Y")`'
output: 
  pdf_document :
    fig_caption: yes
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
knit: (function(inputFile, encoding,...) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here("output/"))})
fig_width: 7
fig_height: 5
out.width: "100%"
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

here::i_am("s-pos-growth.Rmd")
source(here::here("common-setup.R"))
source(here::here("s-pos-clusters.R"))
source(here::here("s-pos-data.R"))



```

# first infection

```{r}
firstInfection %>% with(table(asymptomatic_indicator,sGene))
```

# first taqpath

```{r}
firstTaqpath %>% with(table(asymptomatic_indicator,sGene))
```

# last taqpath

```{r}
lastTaqpath %>% with(table(asymptomatic_indicator,sGene))
```

# infection episodes

```{r}
infectionEpisodes %>% with(table(asymptomatic_indicator,sGene))
```

# Integrate data from Laura and Chris

```{r}


#laura1 = readr::read_csv(here::here("input/R18pIV_31052021_GrowthRate_all_prior2_2_119.csv")) %>% mutate(mean = median, sd = (q0.975-q0.025)/3.92)
laura1 = readr::read_csv(here::here("input/R18pIV_01072021_GrowthRate_all_prior2_2_238.csv"))
#laura2 = readr::read_csv(here::here("input/R18pIV_31052021_GrowthRate_symptomatic_prior2_2_119.csv"))
#laura2 = readr::read_csv(here::here("input/R18pIV_Data31052021_GrowthRate_symptomatic_prior2_2_119.csv"))
laura2 = readr::read_csv(here::here("input/R18pIV_01072021_GrowthRate_symptomatic_prior2_2_238.csv"))

#chris = readr::read_csv(here::here("input/combined_results_UoM-2021-06-01.csv"))
chris = readr::read_csv(here::here("input/combined_results_UoM-2021-07-15.csv"))
david = readr::read_csv(here::here("input/output_complete-2021-06-02.csv"))

laura3 = bind_rows(
  laura2 %>% mutate(dataset = "Symptomatic") %>% select(-code) %>% rename(subgroup2 = subgroup,subgroup=source) %>% rename(source=subgroup2),
  laura1 %>% mutate(dataset = "All") %>% select(-code) %>% rename(subgroup2 = subgroup,subgroup=source) %>% rename(source=subgroup2) %>% mutate()
) %>% 
mutate(
  Growth = mean,
  Growth.SE = sd,
  Growth.median = median, 
  Growth.lower = q0.025,
  Growth.upper = q0.975
) %>% select(-starts_with("q"))
  
chris2 = chris %>% 
  pivot_longer(cols = c(-Region,-Type,-Source,-Status,-Parameter),names_to="date",values_to="value") %>%
  pivot_wider(names_from = "Parameter",values_from="value") %>% rename(
    name = Region,
    subgroup = Type,
    source = Source,
    dataset = Status,
    Growth = `mean growth rate`,
    Growth.SE = `standard deviation`
  ) %>% mutate(
    Growth.median = Growth,
    Growth.lower = Growth-1.96*Growth.SE,
    Growth.upper = Growth+1.96*Growth.SE,
    date = as.Date(date,"%d/%m/%Y"),
    source = stringr::str_to_lower(source),
    subgroup = stringr::str_remove(subgroup,"S ")
  )

david2 = david %>% select(
  date,name, subgroup, source, 
  Growth.median = MAP,
  Growth.lower = lower,
  Growth.upper = upper
) %>% mutate(
  dataset = "Symptomatic"
)

```



# Calculate growth rate ----

```{r}

devtools::load_all("~/Git/uk-covid-datatools/")
ukcovidtools::reload()

allTimeseriesGR = allTimeseries %>% 
  tsp$estimateGrowthRate(window = 28)

allTimeseriesGRPois = allTimeseries %>% 
  tsp$estimatePoissonGrowthRate(window = 56) #smoothingWindow = 14,leftSided=FALSE,nocache=TRUE)

symptomaticTimeseriesGR = symptomaticTimeseries %>% 
  tsp$estimateGrowthRate(window = 28)

symptomaticTimeseriesGRPois = symptomaticTimeseries %>% 
  tsp$estimatePoissonGrowthRate(window = 56)

  #tsp$logIncidenceStats(smoothingWindow = 14,leftSided=FALSE,nocache=TRUE) 

rob = bind_rows(
  allTimeseriesGRPois %>% mutate(dataset = "All",method = "Pois (GLM)"),
  symptomaticTimeseriesGRPois  %>% mutate(dataset = "Symptomatic",method = "Pois (GLM)"),
  allTimeseriesGR %>% mutate(dataset = "All",method = "Pois (Locfit)"),
  symptomaticTimeseriesGR  %>% mutate(dataset = "Symptomatic",method = "Pois (Locfit)")
) %>% select(
  date, name, subgroup, source, dataset, method, 
  Growth = Growth.value, 
  Growth.SE = Growth.SE.value,
  Growth.median = Growth.Quantile.0.5.value,
  Growth.lower = Growth.Quantile.0.025.value,
  Growth.upper = Growth.Quantile.0.975.value
) 


```


<!-- ```{r} -->
<!-- devtools::load_all("~/Git/uk-covid-datatools/") -->
<!-- ukcovidtools::reload() -->

<!-- symptomaticTimeseriesGR = symptomaticTimeseries %>%  -->
<!--   tsp$estimateGrowthRate(window = 56,leftSided=FALSE) %>% -->
<!--   tsp$estimateGrowthRate2(window = 28, nocache=TRUE) -->

<!-- logIncid = bind_rows( -->
<!--   allTimeseriesGR %>% mutate(dataset = "All"), -->
<!--   symptomaticTimeseriesGR  %>% mutate(dataset = "Symptomatic") -->
<!-- ) %>% select( -->
<!--   date,name, subgroup, source, dataset, Growth.Quantile.0.5.value, Growth.Quantile.0.025.value, Growth.Quantile.0.975.value -->
<!-- ) %>% rename( -->
<!--   Growth.median = Growth.Quantile.0.5.value, -->
<!--   Growth.lower = Growth.Quantile.0.025.value, -->
<!--   Growth.upper = Growth.Quantile.0.975.value -->
<!-- ) -->

<!-- allEstimates = bind_rows( -->
<!--   laura3 %>% mutate(method = "GP"), -->
<!--   chris2 %>% mutate(method = "GAM"), -->
<!--   pois %>% mutate(method = "Pois (GLM)"), -->
<!--   david2 %>% mutate(method = "Pois (Bayes)"), -->
<!--   logIncid %>% mutate(method = "Pois (Loess)") -->
<!-- ) -->

<!-- p3 = doGRPlot(allEstimates,names = c("Bolton","M65 Corridor","Manchester"),mergeModels = TRUE)+ -->
<!--   #doModelPlot(names = c("Bolton","M65 Corridor","Manchester"))+ -->
<!--   facet_wrap(vars(name),nrow=1)+ -->
<!--   guides(linetype=guide_none(),colour=guide_none(),fill=guide_none())+ -->
<!--   standardPrintOutput::hideX()+ -->
<!--   theme(plot.margin = margin(0, 0, 0, 0, "mm")) #,axis.ticks.x = element_blank()) -->

<!-- p3 -->
<!-- ``` -->
<!-- Debug M65 Corridor -->

<!-- ```{r} -->

<!-- tmp = symptomaticTimeseries %>% filter(source == "first infection" & subgroup == "positive" & code == "M65 Corridor") %>% arrange(date) -->


<!-- for (i  in 1:nrow(tmp)) { -->
<!--   tmp2 = tmp %>% filter(row_number() > i-28 & row_number()<i+28) -->
<!--   tmp2 = tmp2 %>% rename(I = value) %>% mutate(time = row_number()) -->
<!--   tmp3 = tryCatch({ -->
<!--       model <- suppressWarnings(glm(I ~ time, family = quasipoisson(), data = tmp2)) -->
<!--       model_sum <- summary(model) -->
<!--       print(paste0("gr: ",model_sum$coefficients[2, 1],": ",paste0(tmp2$I, collapse=", "))) -->
<!--   }, error = browser) -->
<!-- } -->


<!-- I_vec = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0) -->
<!-- tmp2 = tibble(time = 1:length(I_vec), I = I_vec) -->
<!-- model <- suppressWarnings(glm(I ~ time, family = quasipoisson(), data = tmp2)) -->
<!-- summary(model) -->

<!-- ``` -->


```{r}

allAreas = as.vector(c(unlist(localClusters),unlist(nationalClusters)))

allEstimates = bind_rows(
  laura3 %>% mutate(method = "GP"),
  chris2 %>% mutate(method = "GAM"),
  # david2 %>% mutate(method = "Pois (Bayes)"),
  rob
)



# growthRateTest = list(
#   input = symptomaticTimeseries %>% filter(source == "infection episodes") %>% ungroup() %>% as_tibble() %>% select(-type,-statistic,-ageCat,-gender,-codeType,-code,-Implicit, -name.original, -note), 
#   output = allEstimates %>% filter(source == "infection episodes" & dataset == "Symptomatic") %>% select(-dataset,-median)
# )
# 
# usethis::use_data(growthRateTest,overwrite = TRUE)

doGRPlot = function(
  allEstimates,
  sources="infection episodes",
  minDate="2021-01-21",
  maxDate=max(allEstimates$date,na.rm=TRUE),
  subgroups = c("positive","negative"),
  datasets="Symptomatic",
  methods = unique(allEstimates$method),
  clustName = paste(names,collapse = "-"),
  names = clusters[[clustName]],
  rlim = c(-0.2,0.2),
  mergeModels = FALSE,
  showDominance = FALSE, completeDominance=NULL, zeroSpos=NULL
  ) {
  
  
    filteredTS = allEstimates %>% 
      filter(source %in% sources & date>minDate & date<maxDate) %>% 
      filter(subgroup %in% subgroups) %>%
      filter(dataset %in% datasets) %>%
      filter(method %in% methods) %>% 
      filter(name %in% names) %>% 
      mutate(name = name %>% ordered(names))
    
    modelEndDate = filteredTS %>% filter(!is.na(Growth)) %>% group_by(source,subgroup,dataset,name,method) %>% summarise(end = max(date,na.rm = TRUE)) %>% pull(end) %>% max(na.rm = TRUE)
    #browser()
    filteredTS = filteredTS %>% filter(date<=modelEndDate)
    
    # if (mergeModels) {
    #   
    #   filteredTS = filteredTS %>% 
    #     group_by(source,subgroup,dataset,name, date) %>%
    #     group_modify(function(d,g,...) {
    #       mus = d$Growth
    #       sigmas = d$Growth.SE
    #       boots = length(mus)
    #       cdf = function(x) LaplacesDemon::pnormm(x, p=rep(1/boots,boots), mu=mus, sigma=sigmas)
    #       # solve CDF for quantiles.
    #       quantGenFn = function(q) return(function(x) cdf(x)-q)
    #       bounds = c(-1,1) #log(c(0.5,5))
    #       mean.estimate = mean(mus)
    #       estimate.lower = tryCatch(uniroot(quantGenFn(0.025), interval=bounds)$root,error = function(e) -Inf)
    #       estimate.median = tryCatch(uniroot(quantGenFn(0.5), interval=bounds)$root,error = function(e) NaN)
    #       estimate.upper = tryCatch(uniroot(quantGenFn(0.975), interval=bounds)$root,error = function(e) Inf)
    #       return(tibble(
    #         Growth.median = estimate.median,
    #         Growth.lower = estimate.lower,
    #         Growth.upper = estimate.upper,
    #         method = "ensemble"
    #       ))
    #     }) %>% ungroup()
    # }
    
    modelComp = ggplot(filteredTS, mapping=aes(x=date))+
      geom_ribbon(mapping=aes(
        ymin=Growth.lower,
        ymax=Growth.upper,
        group=paste0(subgroup,method,dataset)),
        colour=NA, 
        fill="grey60", 
        alpha=0.2)+
      geom_line(mapping=aes(
        y=Growth.median,
        color = subgroup,
        linetype=method)
      )+ 
      scale_y_continuous(
        sec.axis = dup_axis( 
          breaks = log(2)/c(5,10,Inf,-10,-5), 
          labels = c("5","10","\u00B1\u221E","-10","-5"), 
          name="doubling time")
      )+
      scale_x_date(breaks=seq(as.Date(minDate),Sys.Date(),by = 14),date_labels="%d-%m")+  #date_breaks = "2 week",date_labels="%d-%m")+
      scale_color_brewer(name="S-gene",palette = "Set1")+
      coord_cartesian(ylim=rlim, xlim=c(as.Date(minDate),as.Date(maxDate)))+
      ylab("growth rate, r")+
      theme(axis.text.x = element_text(angle=60))+
      geom_hline(yintercept = 0, colour="grey50")+
      xlab("specimen date")
    
    if (showDominance) {
    modelComp = modelComp + 
      geom_vline(data=completeDominance %>% rename(name=area) %>% filter(date > minDate & date < maxDate & name %in% names), mapping = aes(xintercept = date), colour="black")+
      geom_vline(data=zeroSpos %>% rename(name=area) %>% filter(date > minDate & date < maxDate & name %in% names), mapping = aes(xintercept = date), colour="black",linetype="dashed")
    }
    
    #if (!mergeModels) 
      modelComp = modelComp + scale_linetype_manual(values=c("Pois (GLM)"="solid","GAM"="twodash", "GP"="dotted","Pois (Bayes)"="dotdash","Pois (Locfit)"="longdash"))
      
    modelComp
}
```


```{r}
# lapply(names(clusters),function(clustName) {
#   allEstimates %>% 
#     doGRPlot(clustName = clustName) %>% 
#     standardPrintOutput::saveThirdPageFigure(paste0(here::here("output/sGeneAOCHighGrowth-"),clustName))})
```

# FIGURE 2 - Local growth versus Variant composition


```{r}
pSposIsVariantAOC = allVoc %>%
  inner_join(llDemog %>% select(FINALID, LTLA_code), by=c("finalid"="FINALID")) %>%
  inner_join(aocDf %>% select(LTLA_code = code,area), by="LTLA_code") %>%
  filter(sGene == "positive") %>%
  mapVOCtoLineage(vocVar=variant,lineages = c("B.1.617.2","B.1.617.1","B.1.351","P.1 & P.2")) %>%
  group_by(area, type, date=specimen_date) %>%
  summarise(count= n()) %>%
  ungroup() %>%
  tidyr::complete(area, type,date,fill=list(count=0)) %>%
  group_by(area, type) %>%
  arrange(date) %>%
  mutate(Roll.count = stats::filter(count,filter=rep(1/21,21))) %>%
  filter(!is.na(Roll.count)) %>%
  group_by(area, date) %>%
  mutate(binom::binom.confint(Roll.count, sum(Roll.count), conf.level = 0.95, methods = "wilson")) %>%
  ungroup() %>%
  mutate(type = type %>% ordered(vocLevels2))

doPVariantGivenSplusPlot = function(pSposIsVariantAOC, areas, maxDate = max(pSposIsVariantAOC$date), minDate="2021-01-21", showDominance = FALSE, completeDominance=NULL, zeroSpos=NULL) {
  pSposPlotAOC = ggplot(pSposIsVariantAOC %>% filter(date > minDate & date < maxDate & area %in% areas), aes(x=date, y=mean, ymin = lower,ymax=upper,colour=type, fill=type))+
    #geom_ribbon(alpha=0.2,colour=NA)+
    #geom_line(position="stack")+
    geom_area(alpha=0.25,outline.type="both")+
    ylab("Proportion of\nsequenced S+")+
    #theme(legend.title = element_blank())+
    scale_fill_manual(values = palVoc,aesthetics = c("colour","fill"),name=NULL)+
    scale_x_date(breaks=seq(as.Date(minDate),Sys.Date(),by = 14),date_labels="%d-%m")+  #date_breaks = "2 week",date_labels="%d-%m")+
    coord_cartesian(xlim=c(as.Date(minDate),as.Date(maxDate)))
  if (showDominance) {
    pSposPlotAOC = pSposPlotAOC + 
      geom_vline(data=completeDominance %>% filter(date > minDate & date < maxDate & area %in% areas), mapping = aes(xintercept = date), colour="black")+
      geom_vline(data=zeroSpos %>% filter(date > minDate & date < maxDate & area %in% areas), mapping = aes(xintercept = date), colour="black",linetype="dashed")
  }
  pSposPlotAOC
}


```


```{r}



p1 = doGRPlot(allEstimates,names = localClusters$`North West and Midlands`,minDate = "2021-01-21",maxDate = "2021-05-01",mergeModels = TRUE)+
  #doModelPlot(names = c("Bolton","M65 Corridor","Manchester"))+
  facet_wrap(vars(name),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  #guides(linetype=guide_none(),colour=guide_none(),fill=guide_none())+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6,spaceLegend = 1)

p2 = doPVariantGivenSplusPlot(pSposIsVariantAOC,areas = localClusters$`North West and Midlands`,minDate = "2021-01-21", maxDate="2021-05-01")+
  standardPrintOutput::smallLegend(textSize = 6)+
  theme(text = element_text(size=6),legend.justification = "left")+
  facet_wrap(vars(area),nrow=1)+
  standardPrintOutput::hideX()

p3 = doGRPlot(allEstimates,names = localClusters$`London and South East`,minDate = "2021-01-21",maxDate = "2021-05-01",mergeModels = TRUE)+
  #doModelPlot(names = c("Leicester","Nottingham","Birmingham"))+
  facet_wrap(vars(name),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6,spaceLegend = 1)

p4 = doPVariantGivenSplusPlot(pSposIsVariantAOC,areas = localClusters$`London and South East`,minDate = "2021-01-21", maxDate="2021-05-01")+
  facet_wrap(vars(area),nrow=1)+
  theme(axis.text.x.bottom = element_text(angle=60), text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::smallLegend(textSize = 6)


p5 = (p1/p2/p3/p4 + patchwork::plot_annotation(tag_levels="A") + plot_layout(guides = "collect"))

standardPrintOutput::saveHalfPageFigure(p5, paste0(here::here("output/Figure2-"),Sys.Date()))

allEstimates %>% 
  filter(source=="infection episodes" & date>"2021-01-21" & subgroup %in% c("positive","negative") & dataset=="Symptomatic") %>% 
  readr::write_csv(paste0(here::here("output/allEstimates-"),Sys.Date(),".csv"))

```

# Supplementary materials - sensitivity analysis

```{r}

tmp = doGRPlot(allEstimates,
         sources = unique(allEstimates$source),
         methods = c("GP","Pois (GLM)","Pois (Locfit)"),
         #methods = "Pois (Locfit)",
         datasets = "Symptomatic",
         names = allAreas)+
  facet_grid(rows = vars(name), cols=vars(source))+
  standardPrintOutput::smallLegend(spaceLegend = 1)+theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    axis.text.x.bottom = element_text(angle=60), 
    text = element_text(size=6),
    legend.justification = "left"
  )

standardPrintOutput::saveFullPageFigure(tmp,paste0(here::here("output/SuppFig-sensitivity-to-sgene-method-"),Sys.Date()))
```

```{r}
tmp = doGRPlot(allEstimates,
         sources = "infection episodes",
         datasets = c("All","Symptomatic"),
         methods = c("GP","Pois (GLM)","Pois (Locfit)"),
         names = allAreas)+
  facet_wrap(vars(name,dataset),ncol=4)+
  standardPrintOutput::smallLegend(spaceLegend = 1)+theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    axis.text.x.bottom = element_text(angle=60), 
    text = element_text(size=6),
    legend.justification = "left"
  )

standardPrintOutput::saveFullPageFigure(tmp,paste0(here::here("output/SuppFig-sensitivity-to-dataset-"),Sys.Date()))

```

```{r}






sgeneCountsAOC = allEpisodes %>%
  inner_join(llDemog %>% select(FINALID, LTLA_code), by=c("FINALID")) %>%
  inner_join(aocDf %>% select(LTLA_code = code,area), by="LTLA_code") %>%
  #filter(sGene != "unknown") %>%
  group_by(area, sGene, date=earliest_specimen_date) %>%
  summarise(count= n()) %>%
  ungroup() %>%
  tidyr::complete(area, sGene,date,fill=list(count=0)) %>%
  group_by(area, sGene) %>%
  arrange(date) %>%
  mutate(Roll.count = stats::filter(count,filter=rep(1/21,21))) %>%
  filter(!is.na(Roll.count)) %>%
  group_by(area, date) %>%
  mutate(binom::binom.confint(Roll.count, sum(Roll.count), conf.level = 0.95, methods = "wilson")) %>%
  ungroup()

zeroSpos = sgeneCountsAOC %>% group_by(area) %>% filter(sGene=="negative") %>% filter(upper>0.1 | lower>0.05) %>% filter(date == max(date))
completeDominance = pSposIsVariantAOC %>% group_by(area) %>% filter(type=="B.1.617.2") %>% filter(upper<0.95 | lower<0.7) %>% filter(date == max(date))

zeroSposEng = sgeneCounts %>% mutate(area="England") %>% group_by(area) %>% filter(sGene=="negative") %>% filter(upper>0.1 | lower>0.05) %>% filter(date == max(date))
completeDominanceEng = pSposIsVariant %>% mutate(area="England") %>% group_by(area) %>% filter(type=="B.1.617.2") %>% filter(upper<0.95 | lower<0.7) %>% filter(date == max(date))


doPSgeneGivenPositive = function(sgeneCountsAOC, areas, maxDate = max(sgeneCountsAOC$date), minDate="2021-01-21", showDominance = FALSE, completeDominance=NULL, zeroSpos=NULL) {
  p = ggplot(sgeneCountsAOC %>% filter(date > minDate & date < maxDate & area %in% areas), aes(x=date, y=mean, ymin = lower,ymax=upper,colour=sGene, fill=sGene))+
    #geom_ribbon(alpha=0.2,colour=NA)+
    #geom_line(position="stack")+
    geom_area(alpha=0.25,outline.type="both")+
    ylab("Proportion of\nall positive tests")+
    scale_fill_manual(values = sgenePal,aesthetics = c("colour","fill"),name=NULL)+
    scale_x_date(breaks=seq(as.Date(minDate),Sys.Date(),by = 14),date_labels="%d-%m")+  #date_breaks = "2 week",date_labels="%d-%m")+
    coord_cartesian(xlim=c(as.Date(minDate),as.Date(maxDate)))
  if (showDominance) {
    p = p + 
      geom_vline(data=completeDominance %>% filter(date > minDate & date < maxDate & area %in% areas), mapping = aes(xintercept = date), colour="black")+
      geom_vline(data=zeroSpos %>% filter(date > minDate & date < maxDate & area %in% areas), mapping = aes(xintercept = date), colour="black",linetype="dashed")
  }
  p
}
                                 
                                 
# doPSgeneGivenPositive(sgeneCounts %>% mutate(area="England"), areas = nationalClusters$Reference, showDominance = TRUE, completeDominance = completeDominanceEng, zeroSpos = zeroSposEng)

```

```{r}

endDate = min(
  c(
    max(allEstimates$date,na.rm = TRUE),
    max(pSposIsVariant$date,na.rm = TRUE),
    max(pSposIsVariantAOC$date,na.rm = TRUE),
    max(sgeneCounts$date,na.rm = TRUE),
    max(sgeneCountsAOC$date,na.rm = TRUE)
  )
)

p1 = doGRPlot(allEstimates,names = nationalClusters$Reference,minDate = "2021-01-21",maxDate=endDate, showDominance = TRUE, completeDominance = completeDominanceEng, zeroSpos = zeroSposEng, mergeModels = TRUE)+
  #doModelPlot(names = c("Bolton","M65 Corridor","Manchester"))+
  facet_wrap(vars(name),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  #guides(linetype=guide_none(),colour=guide_none(),fill=guide_none())+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6,spaceLegend = 1)

p2 = doPVariantGivenSplusPlot(pSposIsVariant %>% mutate(area = "England"), areas = nationalClusters$Reference, showDominance = TRUE, completeDominance = completeDominanceEng, zeroSpos = zeroSposEng, minDate = "2021-01-21",maxDate=endDate)+
  standardPrintOutput::smallLegend(textSize = 6)+
  theme(text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  facet_wrap(vars(area),nrow=1)

p3 = doPSgeneGivenPositive(sgeneCounts %>% mutate(area="England"), areas = nationalClusters$Reference, showDominance = TRUE, completeDominance = completeDominanceEng, zeroSpos = zeroSposEng, minDate = "2021-01-21",maxDate=endDate)+
  standardPrintOutput::smallLegend(textSize = 6)+
  theme(axis.text.x.bottom = element_text(angle=60), text = element_text(size=6),legend.justification = "left")+
  facet_wrap(vars(area),nrow=1)

p4 = doGRPlot(allEstimates,names = nationalClusters$`NHS Regions (N)`,minDate = "2021-01-21",maxDate=endDate, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos)+
  #doModelPlot(names = c("Leicester","Nottingham","Birmingham"))+
  facet_wrap(vars(name),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6,spaceLegend = 1)

p5 = doPVariantGivenSplusPlot(pSposIsVariantAOC, areas = nationalClusters$`NHS Regions (N)`, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos,minDate = "2021-01-21",maxDate=endDate)+
  facet_wrap(vars(area),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6)

p6 = doPSgeneGivenPositive(sgeneCountsAOC, areas = nationalClusters$`NHS Regions (N)`, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos, minDate = "2021-01-21",maxDate=endDate)+
  standardPrintOutput::smallLegend(textSize = 6)+
  theme(axis.text.x.bottom = element_text(angle=60),text = element_text(size=6),legend.justification = "left")+
  facet_wrap(vars(area),nrow=1)

p7 = doGRPlot(allEstimates,names = nationalClusters$`NHS Regions (S)`,minDate = "2021-01-21",maxDate=endDate,mergeModels = TRUE, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos)+
  #doModelPlot(names = c("Leicester","Nottingham","Birmingham"))+
  facet_wrap(vars(name),nrow=1)+
  theme(text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6,spaceLegend = 1)

p8 = doPVariantGivenSplusPlot(pSposIsVariantAOC, areas = nationalClusters$`NHS Regions (S)`, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos,minDate = "2021-01-21",maxDate=endDate)+
  facet_wrap(vars(area),nrow=1)+
  theme(axis.text.x = element_text(angle=60), text = element_text(size=6),legend.justification = "left")+
  standardPrintOutput::hideX()+
  standardPrintOutput::smallLegend(textSize = 6)

p9 = doPSgeneGivenPositive(sgeneCountsAOC, areas = nationalClusters$`NHS Regions (S)`, showDominance = TRUE, completeDominance = completeDominance, zeroSpos = zeroSpos, minDate = "2021-01-21",maxDate=endDate)+
  standardPrintOutput::smallLegend(textSize = 6)+
  theme(text = element_text(size=6),legend.justification = "left",axis.text.x.bottom = element_text(angle=60))+
  facet_wrap(vars(area),nrow=1)

p10 = (p1/p2/p3) + patchwork::plot_annotation(tag_levels="A") + plot_layout(guides = "collect")
p11 = (p4/p5/p6) + patchwork::plot_annotation(tag_levels="A") + plot_layout(guides = "collect")
p12 = (p7/p8/p9) + patchwork::plot_annotation(tag_levels="A") + plot_layout(guides = "collect")

standardPrintOutput::saveHalfPageFigure(p10, paste0(here::here("output/SuppFig-growthENG-"),Sys.Date()))
standardPrintOutput::saveHalfPageFigure(p11, paste0(here::here("output/SuppFig-growthNHSER1-"),Sys.Date()))
standardPrintOutput::saveHalfPageFigure(p12, paste0(here::here("output/SuppFig-growthNHSER2-"),Sys.Date()))


```

# Figure 4 - Advantage






## Transmission advantage

$$

\alpha = shape \\
\beta = rate \\

G \sim \Gamma(\alpha,\beta) \\

\bar{G} = E(G) = \alpha/\beta \\
\bar{S}^2 = V(G) = \alpha/\beta^2 \\
\alpha = \frac{\bar{G}^2}{\bar{S}^2} \\
\beta = \frac{\bar{G}}{\bar{S}^2} \\

\kappa = 1/\alpha \\


R = (1+r\kappa \bar{G} )^{1/\kappa} \\
R = (1+\frac{r}{\beta})^\alpha\\


$$ 
Solutions only exist for situation where $r > -\beta \implies r > -\bar{G}/\bar{S}^2$


## Transmission advantage $T$ of strain 1 over strain 2:

$$

T_{1>2} = \frac{R_1}{R_2} \\
 
$$

assuming $\alpha$ & $\beta$ is unchanged between variants:

$$

T_{1>2} = \Big(\frac{\beta+r_1}{\beta+r_2}\Big)^\alpha \\

$$
# Empirical distributions

$$
R = \frac{r}{\sum_{i=1}^n{\frac{y_i}{a_i-a_{i-1}}(e^{-ra_{i-1}} - e^{-ra_i})}}
$$

```{r}
gtPosterior = readxl::read_xlsx(here::here("input/GT_posterior.xlsx")) %>% mutate(
    alpha = mean^2/sd^2,
    beta = mean/sd^2
  )

gtPosteriorMech = readxl::read_xlsx(here::here("input/GT_posterior_mech.xlsx")) %>% mutate(
    alpha = mean^2/sd^2,
    beta = mean/sd^2
  )


generationIntervals = readr::read_csv(here::here("input/generation-intervals.csv"))
generationIntervals = generationIntervals %>% pivot_wider(values_from = value, names_from=param) %>% mutate(
  alpha = shape,
  beta = rate
)


```

```{r}
doAdvantage = function(
  allEstimates,
  gtAssumptions,
  names,
  sources="infection episodes",
  advFilter = subgroup=="positive",
  disadvFilter = subgroup=="negative",
  datasets="Symptomatic",
  methods = unique(allEstimates$method)
  ) {
 
  disadvFilter = enexpr(disadvFilter)
  advFilter = enexpr(advFilter)
  
  # browser()
  
  gtAssumptions = gtAssumptions %>% mutate(
    a = list(c(seq(0.5,19.5),25)),
    y = purrr::pmap(list(alpha,beta,a), function(.shape,.rate,.p) { pgamma(.p,.shape,.rate)-lag(pgamma(.p,.shape,.rate),default=0) }),
  )
  
  filteredTS = allEstimates %>% 
    filter(source %in% sources) %>%
    filter(dataset %in% datasets) %>%
    filter(method %in% methods) %>% 
    filter(name %in% names) %>% 
    mutate(name = name %>% ordered(names)) %>%
    filter(!!disadvFilter | !!advFilter) %>%
    filter(!is.na(Growth) & !is.na(Growth.SE))
  
  # filteredTS = filteredTS %>% group_by(source,date,subgroup,dataset,method,name)
  # browser()
  precalc = purrr::map2(gtAssumptions$a,gtAssumptions$y,function(a,y) y/(a - lag(a,default=0)))
  
  discGRToR = function(r, y = gtAssumptions$y, a = gtAssumptions$a, p=precalc) {
    R = pmap(list(r,a,y,p), function(r,a,y,p) {
      # browser(); 
      # tmp = r/sum(y*(exp(-r*lag(a,default=0))-exp(-r*a))/(a - lag(a,default=0)))
      tmp = r/sum(p*(exp(-r*lag(a,default=0))-exp(-r*a)))
      # if(!is.finite(tmp)) browser()
      return(tmp)
    })
    #browser()
    return(unlist(R))
  }
  
  filteredTS = filteredTS %>% mutate(
    # this is the num / denominator of the fractions above. 
    # and is probably an R estimate
    # keep this as a list column for now
    bootstrap = map2( Growth, Growth.SE, function(mean,sd) {
      tibble(
        id = 1:nrow(gtAssumptions),
        # alpha = gtAssumptions$alpha,
        # beta = gtAssumptions$beta,
        sample_r = rnorm(nrow(gtAssumptions),mean,sd), 
        R = ( 1 + sample_r/gtAssumptions$beta ) ^ gtAssumptions$alpha,
        R_disc = discGRToR(sample_r)
      )
    })
  # ) %>% mutate(
  #   R.mean = purrr::map_dbl(bootstrap, function(.x) mean(.x$R)),
  #   R.sd = purrr::map_dbl(bootstrap, function(.x) sd(.x$R))
  )
  
  # browser()
  
  disadv = filteredTS %>% filter(!!disadvFilter)
  adv = filteredTS %>% filter(!!advFilter)
  
  compare = adv %>% inner_join(disadv, by=c("source","date","dataset","method","name"), suffix=c(".adv",".disadv"))
  
  # calculate the ratio for each bootstrap.
  compare2 = compare %>% mutate(bootstrap = purrr::map2(bootstrap.adv, bootstrap.disadv, function(adv,disadv) {
    adv %>% inner_join(disadv, by="id", suffix=c(".adv",".disadv")) %>% mutate(
      #transadv = R.adv/R.disadv,
      transadv = R_disc.adv/R_disc.disadv
      )
  })) %>% select(-bootstrap.adv, -bootstrap.disadv)
  
  return(compare2)
}
 
summariseAdvantage = function(compare, combineDays=FALSE,mergeModels = FALSE, completeDominance=NULL, zeroSpos=NULL) {
  # Options are:
  
  if(combineDays) {
    compare2 = compare %>% 
      mutate(name = as.character(name)) %>% 
      inner_join(completeDominance %>% select(name=area,date), by="name",suffix=c("",".after")) %>% 
      inner_join(zeroSpos %>% select(name=area,date), by="name",suffix=c("",".before")) %>% 
      filter(date > date.after & date < date.before)
  } else {
    compare2 = compare %>%
      mutate(
        date.after = min(date)-1,
        date.before = max(date)+1
      )
  }
  
  compare2 = compare2 %>% unnest(bootstrap)
  
  # Summarise bootstraps for each day
  compare2 = compare2 %>% group_by(source,dataset,name)
  # merge methods
  if (!mergeModels) compare2 = compare2 %>% group_by(method, .add=TRUE)
  # Summarise bootstraps for all days
  if (!combineDays) {
    compare2 = compare2 %>% group_by(date, .add=TRUE)
  } else {
    compare2 = compare2 %>% group_by(date.after,date.before, .add=TRUE)
  }
  
  # browser()
  # grps == compare2 %>% groups()
  # compare2 = compare2 %>% summarise(
  #     bootstrap = bind_rows(bootstrap),
  #     bootstrap.adv = bind_rows(bootstrap.adv),
  #     bootstrap.disadv = bind_rows(bootstrap.disadv),
  # )
  
  out = compare2 %>% summarise(
    transadv.mean = mean(transadv),
    transadv.sd = sd(transadv),
    
    transadv.Quantile.0.025 = quantile(transadv,0.025),
    transadv.Quantile.0.25 = quantile(transadv,0.25),
    transadv.Quantile.0.5 = quantile(transadv,0.5),
    transadv.Quantile.0.75 = quantile(transadv,0.75),
    transadv.Quantile.0.975 = quantile(transadv,0.975),
    
    R.adv.mean = mean(R_disc.adv),
    R.adv.sd = sd(R_disc.adv),
    R.disadv.mean = mean(R_disc.disadv),
    R.disadv.sd = sd(R_disc.disadv)
  )
  
  return(out)
  
}

allNational =  as.vector(unlist(nationalClusters))


completeDominanceAll = bind_rows(
  completeDominance %>% select(area,date) %>% mutate(area = as.character(area)),
  completeDominanceEng %>% select(area,date) %>% mutate(area="England")
)

zeroSposAll = bind_rows(
  zeroSpos %>% select(area,date) %>% mutate(area = as.character(area)),
  zeroSposEng %>% select(area,date) %>% mutate(area="England")
)

completeDominanceAll %>% inner_join(zeroSposAll, by="area", suffix=c(".from",".to")) %>% readr::write_csv(here::here("output/timelimits-for-transmission-advantage-calculation.csv"))

# tmpTest = allEstimates %>% doAdvantage(names = allNational, gtAssumptions = generationIntervals %>% sample_n(10, replace = TRUE), methods = "Pois (Locfit)")
# tmpTest %>% summariseAdvantage(combineDays = TRUE, mergeModels = TRUE, completeDominance = completeDominanceAll, zeroSpos = zeroSposAll)

```

```{r}
tmp = allEstimates %>% doAdvantage(gtAssumptions = gtPosterior %>% sample_n(500, replace = TRUE),names = allNational) #,methods = "GP") #Pois (Locfit)")

unsummarised = tmp %>% summariseAdvantage()
# tmp2 = allEstimates %>% doAdvantage(gtAssumptions = gtPosterior %>% sample_n(500, replace = TRUE),names = allAreas)
# ggplot(tmp %>% filter(date>"2021-02-01"), aes(x=date, y=transadv.Quantile.0.5, ymin=transadv.Quantile.0.025,ymax=transadv.Quantile.0.975))+geom_ribbon(fill="grey80",colour=NA)+geom_line()+facet_wrap(vars(name))+coord_cartesian(ylim=c(0,3))




```


```{r}
summarised = tmp %>% summariseAdvantage(mergeModels = TRUE,combineDays = TRUE, completeDominance = completeDominanceAll, zeroSpos = zeroSposAll)

summarised %>% ungroup() %>% mutate(
  Level = ifelse(name=="England","Country","NHS region"),
  "Date range" = sprintf("%s \u2013 %s",as.character(date.after,"%d %b"),as.character(date.before,"%d %b")),
  "Reproduction number ratio" = sprintf("%1.2f (%1.2f\u2013%1.2f)",transadv.Quantile.0.5,transadv.Quantile.0.025,transadv.Quantile.0.975),
  "Reproduction number ratio (percentage)" = sprintf("%1.0f%% (%1.0f%%\u2013%1.0f%%)",(transadv.Quantile.0.5-1)*100,(transadv.Quantile.0.025-1)*100,(transadv.Quantile.0.975-1)*100)
) %>% select(Level,Name = name,`Date range`,`Reproduction number ratio (ratio)`,`Reproduction number ratio (percentage)`) %>% group_by(Level) %>%
  standardPrintOutput::saveTable(paste0(here::here("output/transmission-advantage-table-"),Sys.Date()))
```

# Transmission advantage over time and region

```{r}
doTransAdvPlot = function(names,unsummarised,summarised, minDate="2021-01-21", maxDate=max(unsummarised$date,na.rm=TRUE)) {
  tmp2 = unsummarised %>% filter(name %in% names)
  tmp3 = summarised %>% filter(name %in% names)

  p= ggplot(tmp2 %>% filter(date>minDate), aes(x=date, y=transadv.mean, ymin=transadv.Quantile.0.025,ymax=transadv.Quantile.0.975))+
    geom_ribbon(aes(group=method),fill="grey70",colour=NA,alpha=0.4)+
    geom_line(aes(colour=method))+
    facet_wrap(vars(name))+coord_cartesian(ylim=c(0,2.5))+
    geom_hline(yintercept=1,colour="black")+
    geom_rect(data=tmp3, inherit.aes=FALSE, mapping=aes(ymin=transadv.Quantile.0.025,ymax=transadv.Quantile.0.975,xmin=date.after,xmax=date.before),colour=NA,fill="grey20",alpha=0.35)+
    geom_segment(data=tmp3, inherit.aes=FALSE,  mapping=aes(y=transadv.Quantile.0.5,yend=transadv.Quantile.0.5,x=date.after,xend=date.before),colour="black")+
    scale_x_date(breaks=seq(as.Date(minDate),Sys.Date(),by = 14),date_labels="%d-%m")+xlab(NULL)+
    ylab(latex2exp::TeX("\\frac{R_t(S_{pos})}{R_t(S_{neg})}"))+
    standardPrintOutput::smallLegend()+
    coord_cartesian(ylim=c(0.5,2.25))+
    theme(axis.text.x.bottom = element_text(angle=60), text=element_text(size=6))
  return(p)
}

p1 = doTransAdvPlot(names = "England",unsummarised,summarised)
p2 = doTransAdvPlot(names = nationalClusters$`NHS Regions (N)`,unsummarised,summarised)+facet_wrap(vars(name),nrow=1)+standardPrintOutput::hideX()
p3 = doTransAdvPlot(names = nationalClusters$`NHS Regions (S)`,unsummarised,summarised)+facet_wrap(vars(name),nrow=1)



p10 = (p1/p2/p3) + patchwork::plot_annotation(tag_levels="A") + plot_layout(guides = "collect")
#p10
standardPrintOutput::saveHalfPageFigure(p10, paste0(here::here("output/Fig4-GrowthAdvantage-"),Sys.Date()))

```



